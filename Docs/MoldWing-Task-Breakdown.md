# MoldWing 任务拆分（Qt 方案）

> **版本**: 2.0
> **创建日期**: 2025-12-26
> **拆分层次**: Epic (里程碑) → Story (功能模块) → Task (具体任务)

---

## 技术栈

| 组件 | 技术 |
|-----|------|
| UI框架 | **Qt 6 Widgets** |
| 渲染引擎 | DiligentEngine |
| 几何处理 | CGAL + Eigen3 |
| 模型加载 | assimp |

---

## 任务依赖关系图

```
M1 基础框架 ──┬──> M2 框选 ──> M3 刷选 ──> M4 套索 ──> M5 连通
(Qt+Diligent) │
              ├──> M6 纹理视图 ──┬──> M7 基础绘制
              │                  ├──> M8 修复工具
              │                  └──> M9 颜色调整
              │
              └──> M10 几何修复 ──> M11 导入导出
```

---

## M1: 基础框架（Qt + DiligentEngine）

### S1.1 项目骨架搭建
| ID | Task | 预计 | 依赖 |
|----|------|------|------|
| T1.1.1 | 创建 Apps/MoldWing/ 目录结构 | 0.5h | - |
| T1.1.2 | 编写 CMakeLists.txt（Qt6 + DiligentEngine） | 1.5h | T1.1.1 |
| T1.1.3 | 更新 vcpkg.json 添加依赖 | 0.5h | - |
| T1.1.4 | 创建 main.cpp（QApplication 入口） | 0.5h | T1.1.2 |
| T1.1.5 | 验证 Qt 窗口显示 | 0.5h | T1.1.4 |

### S1.2 Qt + DiligentEngine 集成
| ID | Task | 预计 | 依赖 |
|----|------|------|------|
| T1.2.1 | 创建 DiligentWidget 类（QWidget子类） | 1h | S1.1 |
| T1.2.2 | 获取 Qt 窗口原生句柄 (winId) | 0.5h | T1.2.1 |
| T1.2.3 | 初始化 DiligentEngine Device/Context | 2h | T1.2.2 |
| T1.2.4 | 创建 SwapChain 绑定到 Qt 窗口 | 1h | T1.2.3 |
| T1.2.5 | 实现 paintEvent 触发渲染 | 1h | T1.2.4 |
| T1.2.6 | 实现 resizeEvent 处理窗口大小变化 | 0.5h | T1.2.5 |
| T1.2.7 | 验证基础渲染（清屏颜色） | 0.5h | T1.2.6 |

### S1.3 网格数据结构
| ID | Task | 预计 | 依赖 |
|----|------|------|------|
| T1.3.1 | 定义 Vertex 结构体（position, normal, texcoord） | 0.5h | S1.1 |
| T1.3.2 | 定义 MeshData 结构体（vertices, indices） | 0.5h | T1.3.1 |
| T1.3.3 | 定义 TextureData 结构体（使用 QImage） | 0.5h | T1.3.1 |
| T1.3.4 | 实现邻接表构建 | 1h | T1.3.2 |

### S1.4 模型加载（assimp）
| ID | Task | 预计 | 依赖 |
|----|------|------|------|
| T1.4.1 | 集成 assimp 库 | 0.5h | S1.1 |
| T1.4.2 | 实现 MeshLoader::loadOBJ() | 2h | T1.4.1, S1.3 |
| T1.4.3 | 加载纹理（QImage / stb_image） | 1h | T1.4.2 |
| T1.4.4 | 测试加载示例 OBJ 模型 | 0.5h | T1.4.3 |

### S1.5 网格渲染
| ID | Task | 预计 | 依赖 |
|----|------|------|------|
| T1.5.1 | 创建顶点缓冲和索引缓冲 | 1h | S1.4, S1.2 |
| T1.5.2 | 编写顶点着色器（MVP变换） | 1h | T1.5.1 |
| T1.5.3 | 编写片段着色器（Blinn-Phong光照） | 1h | T1.5.2 |
| T1.5.4 | 创建图形管线 PSO | 1h | T1.5.3 |
| T1.5.5 | 实现 MeshRenderer::render() | 1h | T1.5.4 |
| T1.5.6 | 添加纹理采样支持 | 1h | T1.5.5 |

### S1.6 相机系统
| ID | Task | 预计 | 依赖 |
|----|------|------|------|
| T1.6.1 | 实现 OrbitCamera 类 | 1h | S1.2 |
| T1.6.2 | 重写 mousePressEvent（开始拖拽） | 0.5h | T1.6.1 |
| T1.6.3 | 重写 mouseMoveEvent（旋转/平移） | 1h | T1.6.2 |
| T1.6.4 | 重写 wheelEvent（缩放） | 0.5h | T1.6.1 |
| T1.6.5 | 实现 fitToModel()（自动适配） | 0.5h | T1.6.4 |

### S1.7 撤销/重做系统（QUndoStack）
| ID | Task | 预计 | 依赖 |
|----|------|------|------|
| T1.7.1 | 创建 QUndoStack | 0.5h | S1.1 |
| T1.7.2 | 创建 QUndoView 显示历史 | 0.5h | T1.7.1 |
| T1.7.3 | 配置 Ctrl+Z / Ctrl+Y 快捷键 | 0.5h | T1.7.1 |

### S1.8 Qt 主窗口布局
| ID | Task | 预计 | 依赖 |
|----|------|------|------|
| T1.8.1 | 创建 MainWindow 类（QMainWindow） | 1h | S1.2 |
| T1.8.2 | 设置 DiligentWidget 为中央窗口 | 0.5h | T1.8.1 |
| T1.8.3 | 创建左侧工具 QDockWidget | 1h | T1.8.1 |
| T1.8.4 | 创建右侧属性 QDockWidget | 1h | T1.8.1 |
| T1.8.5 | 创建历史记录 QDockWidget（tabify） | 0.5h | T1.8.4 |
| T1.8.6 | 创建菜单栏（文件/编辑/视图） | 1h | T1.8.1 |
| T1.8.7 | 创建工具栏 | 1h | T1.8.1 |
| T1.8.8 | 创建状态栏 | 0.5h | T1.8.1 |
| T1.8.9 | 实现 saveState/restoreState 布局保存 | 0.5h | T1.8.5 |

**M1 总计: ~30h**

---

## M2: 框选

### S2.1 GPU 拾取系统
| ID | Task | 预计 | 依赖 |
|----|------|------|------|
| T2.1.1 | 创建 ID 渲染目标（R32_UINT格式） | 1h | M1 |
| T2.1.2 | 编写 ID 渲染着色器 | 1h | T2.1.1 |
| T2.1.3 | 实现 renderIDBuffer() | 1h | T2.1.2 |
| T2.1.4 | 实现 readFaceID(screenPos) | 1h | T2.1.3 |
| T2.1.5 | 实现 readFaceIDsInRect() | 1h | T2.1.4 |

### S2.2 选择系统核心
| ID | Task | 预计 | 依赖 |
|----|------|------|------|
| T2.2.1 | 创建 SelectionSystem 类（QObject） | 0.5h | S2.1 |
| T2.2.2 | 实现 selectedFaces 集合管理 | 0.5h | T2.2.1 |
| T2.2.3 | 定义 selectionChanged 信号 | 0.2h | T2.2.1 |
| T2.2.4 | 实现 invertSelection() | 0.5h | T2.2.2 |
| T2.2.5 | 实现 clearSelection() | 0.2h | T2.2.2 |
| T2.2.6 | 实现 selectAll() | 0.2h | T2.2.2 |
| T2.2.7 | 创建 SelectFacesCommand（QUndoCommand） | 1h | T2.2.2 |

### S2.3 框选实现
| ID | Task | 预计 | 依赖 |
|----|------|------|------|
| T2.3.1 | 处理 mousePressEvent 开始框选 | 0.5h | S2.2 |
| T2.3.2 | 处理 mouseMoveEvent 更新框选 | 0.5h | T2.3.1 |
| T2.3.3 | 使用 QPainter 绘制框选矩形 | 1h | T2.3.2 |
| T2.3.4 | 处理 mouseReleaseEvent 完成框选 | 1h | T2.3.3 |
| T2.3.5 | 支持 Shift 加选 / Ctrl 减选 | 0.5h | T2.3.4 |

### S2.4 选择可视化
| ID | Task | 预计 | 依赖 |
|----|------|------|------|
| T2.4.1 | 创建选中面高亮着色器 | 1h | S2.3 |
| T2.4.2 | 实现 SelectionRenderer 类 | 1h | T2.4.1 |
| T2.4.3 | 支持选中面半透明叠加 | 0.5h | T2.4.2 |

**M2 总计: ~14h**

---

## M3: 刷选

### S3.1 刷选核心
| ID | Task | 预计 | 依赖 |
|----|------|------|------|
| T3.1.1 | 添加 SelectMode::Brush 模式 | 0.5h | M2 |
| T3.1.2 | 实现 brushRadius 属性 | 0.2h | T3.1.1 |
| T3.1.3 | 实现 updateBrushSelect() | 1h | T3.1.2 |
| T3.1.4 | 使用 QPainter 绘制刷选圆形光标 | 1h | T3.1.3 |
| T3.1.5 | 支持 [ ] 快捷键调整笔刷大小 | 0.5h | T3.1.4 |

### S3.2 刷选优化
| ID | Task | 预计 | 依赖 |
|----|------|------|------|
| T3.2.1 | 优化：仅检测笔刷范围内的面 | 1h | S3.1 |
| T3.2.2 | 支持持续拖拽选择 | 0.5h | T3.2.1 |
| T3.2.3 | 属性面板：笔刷大小滑块 (QSlider) | 0.5h | T3.2.2 |

**M3 总计: ~5h**

---

## M4: 套索选择

### S4.1 套索核心
| ID | Task | 预计 | 依赖 |
|----|------|------|------|
| T4.1.1 | 添加 SelectMode::Lasso 模式 | 0.5h | M3 |
| T4.1.2 | 使用 QPolygonF 记录鼠标轨迹 | 0.5h | T4.1.1 |
| T4.1.3 | 使用 QPainter 绘制套索轨迹 | 1h | T4.1.2 |
| T4.1.4 | 实现多边形闭合检测 | 0.5h | T4.1.3 |

### S4.2 点在多边形内判断
| ID | Task | 预计 | 依赖 |
|----|------|------|------|
| T4.2.1 | 使用 QPolygonF::containsPoint() | 0.5h | S4.1 |
| T4.2.2 | 实现 endLassoSelect() | 1h | T4.2.1 |
| T4.2.3 | 优化：采样点简化 | 0.5h | T4.2.2 |

**M4 总计: ~5h**

---

## M5: 连通选择

### S5.1 邻接关系
| ID | Task | 预计 | 依赖 |
|----|------|------|------|
| T5.1.1 | 构建面-面邻接表 | 1h | M4 |
| T5.1.2 | 缓存邻接关系 | 0.5h | T5.1.1 |

### S5.2 连通选择
| ID | Task | 预计 | 依赖 |
|----|------|------|------|
| T5.2.1 | 添加 SelectMode::Link 模式 | 0.5h | S5.1 |
| T5.2.2 | 实现 selectLinked() BFS | 1h | T5.2.1 |
| T5.2.3 | 实现 selectByAngle() 角度限制 | 1h | T5.2.2 |
| T5.2.4 | 属性面板：角度阈值滑块 | 0.5h | T5.2.3 |

### S5.3 选择扩展/收缩
| ID | Task | 预计 | 依赖 |
|----|------|------|------|
| T5.3.1 | 实现 growSelection() | 0.5h | S5.2 |
| T5.3.2 | 实现 shrinkSelection() | 0.5h | T5.3.1 |

**M5 总计: ~6h**

---

## M6: 纹理视图

### S6.1 UV窗口
| ID | Task | 预计 | 依赖 |
|----|------|------|------|
| T6.1.1 | 创建 UVViewWidget（QWidget） | 1h | M2 |
| T6.1.2 | 使用 QPainter 渲染纹理 | 1h | T6.1.1 |
| T6.1.3 | 实现 UV 视图缩放/平移 | 1h | T6.1.2 |
| T6.1.4 | 绘制 UV 网格线 | 1h | T6.1.3 |

### S6.2 选区同步
| ID | Task | 预计 | 依赖 |
|----|------|------|------|
| T6.2.1 | 计算选中面的 UV 范围 | 1h | S6.1 |
| T6.2.2 | 在 UV 视图中高亮选区 | 1h | T6.2.1 |
| T6.2.3 | 支持 UV 视图内选择面 | 1h | T6.2.2 |

**M6 总计: ~7h**

---

## M7: 基础绘制

### S7.1 笔刷引擎
| ID | Task | 预计 | 依赖 |
|----|------|------|------|
| T7.1.1 | 创建 BrushEngine 类 | 0.5h | M6 |
| T7.1.2 | 实现 createCircleBrush() | 1h | T7.1.1 |
| T7.1.3 | 实现笔刷 hardness | 0.5h | T7.1.2 |
| T7.1.4 | 实现笔画插值 | 1h | T7.1.3 |

### S7.2 混合模式
| ID | Task | 预计 | 依赖 |
|----|------|------|------|
| T7.2.1 | 定义 BlendMode 枚举 | 0.2h | S7.1 |
| T7.2.2 | 实现 Normal 混合 | 0.5h | T7.2.1 |
| T7.2.3 | 实现 Multiply/Screen/Overlay | 1h | T7.2.2 |
| T7.2.4 | 实现 opacity 不透明度 | 0.5h | T7.2.3 |

### S7.3 绘制工具
| ID | Task | 预计 | 依赖 |
|----|------|------|------|
| T7.3.1 | 实现画笔工具 | 1h | S7.2 |
| T7.3.2 | 实现橡皮擦工具 | 0.5h | T7.3.1 |
| T7.3.3 | 实现填充工具 | 1h | T7.3.2 |
| T7.3.4 | 实现渐变工具（QLinearGradient） | 1h | T7.3.3 |
| T7.3.5 | 创建 TextureEditCommand | 1h | T7.3.4 |

### S7.4 实时预览
| ID | Task | 预计 | 依赖 |
|----|------|------|------|
| T7.4.1 | 实现 workingTexture | 0.5h | S7.3 |
| T7.4.2 | 实现 GPU 纹理更新 | 1h | T7.4.1 |
| T7.4.3 | 实现 confirmEdit() / cancelEdit() | 0.5h | T7.4.2 |

### S7.5 UI
| ID | Task | 预计 | 依赖 |
|----|------|------|------|
| T7.5.1 | 颜色选择器（QColorDialog） | 0.5h | S7.4 |
| T7.5.2 | 笔刷设置面板 | 1h | T7.5.1 |
| T7.5.3 | 混合模式下拉框（QComboBox） | 0.5h | T7.5.2 |
| T7.5.4 | 快捷键 B/E/G | 0.5h | T7.5.3 |

**M7 总计: ~14h**

---

## M8: 克隆/修复工具

### S8.1 克隆图章
| ID | Task | 预计 | 依赖 |
|----|------|------|------|
| T8.1.1 | 实现 setCloneSource() | 0.5h | M7 |
| T8.1.2 | 实现 CloneStamp 绘制 | 2h | T8.1.1 |
| T8.1.3 | 显示克隆源点标记 | 0.5h | T8.1.2 |
| T8.1.4 | 快捷键 Alt+Click 设置源点 | 0.5h | T8.1.3 |

### S8.2 修复画笔
| ID | Task | 预计 | 依赖 |
|----|------|------|------|
| T8.2.1 | 实现 HealingBrush | 3h | S8.1 |
| T8.2.2 | 实现 Smudge 涂抹 | 1h | T8.2.1 |
| T8.2.3 | 实现 Blur 模糊 | 1h | T8.2.2 |
| T8.2.4 | 实现 Sharpen 锐化 | 1h | T8.2.3 |

**M8 总计: ~10h**

---

## M9: 颜色调整

### S9.1 基础调整
| ID | Task | 预计 | 依赖 |
|----|------|------|------|
| T9.1.1 | 实现 adjustBrightness() | 1h | M7 |
| T9.1.2 | 实现 adjustContrast() | 1h | T9.1.1 |
| T9.1.3 | 实现 adjustHueSaturation() | 1.5h | T9.1.2 |
| T9.1.4 | 创建 ColorAdjustCommand | 1h | T9.1.3 |

### S9.2 高级调整
| ID | Task | 预计 | 依赖 |
|----|------|------|------|
| T9.2.1 | 实现 applyLevels() | 1.5h | S9.1 |
| T9.2.2 | 实现 applyCurves() | 2h | T9.2.1 |

### S9.3 调整UI
| ID | Task | 预计 | 依赖 |
|----|------|------|------|
| T9.3.1 | 亮度/对比度滑块 | 0.5h | S9.2 |
| T9.3.2 | 色相/饱和度滑块 | 0.5h | T9.3.1 |
| T9.3.3 | 色阶直方图（QCustomPlot或手绘） | 1h | T9.3.2 |
| T9.3.4 | 曲线编辑器 | 2h | T9.3.3 |

**M9 总计: ~12h**

---

## M10: 几何修复

### S10.1 CGAL 集成
| ID | Task | 预计 | 依赖 |
|----|------|------|------|
| T10.1.1 | 配置 CGAL + Eigen3 | 1h | M5 |
| T10.1.2 | MeshData ↔ CGAL Surface_mesh 转换 | 2h | T10.1.1 |

### S10.2 孔洞检测与填充
| ID | Task | 预计 | 依赖 |
|----|------|------|------|
| T10.2.1 | 实现 detectHoles() | 1h | S10.1 |
| T10.2.2 | 实现孔洞边缘高亮 | 1h | T10.2.1 |
| T10.2.3 | 实现 fillHole() | 2h | T10.2.2 |
| T10.2.4 | 实现 fillAllHoles() | 0.5h | T10.2.3 |
| T10.2.5 | 创建 FillHoleCommand | 1h | T10.2.4 |

### S10.3 网格清理
| ID | Task | 预计 | 依赖 |
|----|------|------|------|
| T10.3.1 | 实现 analyzeMesh() | 1h | S10.1 |
| T10.3.2 | 实现非流形边修复 | 2h | T10.3.1 |
| T10.3.3 | 实现重复顶点合并 | 1h | T10.3.2 |
| T10.3.4 | 实现退化三角形删除 | 1h | T10.3.3 |

### S10.4 删除选中面
| ID | Task | 预计 | 依赖 |
|----|------|------|------|
| T10.4.1 | 实现 deleteSelectedFaces() | 1h | S10.3 |
| T10.4.2 | 创建 DeleteFacesCommand | 1h | T10.4.1 |

**M10 总计: ~16h**

---

## M11: 导入导出

### S11.1 OBJ 导出
| ID | Task | 预计 | 依赖 |
|----|------|------|------|
| T11.1.1 | 实现 saveOBJ() | 2h | M10 |
| T11.1.2 | 导出纹理文件 | 1h | T11.1.1 |
| T11.1.3 | 生成 MTL 材质文件 | 1h | T11.1.2 |

### S11.2 PLY 导出
| ID | Task | 预计 | 依赖 |
|----|------|------|------|
| T11.2.1 | 实现 savePLY() | 1h | S11.1 |

### S11.3 OSGB 支持
| ID | Task | 预计 | 依赖 |
|----|------|------|------|
| T11.3.1 | 研究 OSGB 格式 | 2h | S11.1 |
| T11.3.2 | 集成 osg/osgDB | 4h | T11.3.1 |
| T11.3.3 | 实现 loadOSGB() | 4h | T11.3.2 |
| T11.3.4 | 实现 saveOSGB() | 3h | T11.3.3 |

**M11 总计: ~18h**

---

## 任务统计

| 里程碑 | 预计工时 | 累计 |
|-------|---------|------|
| M1 基础框架 | 30h | 30h |
| M2 框选 | 14h | 44h |
| M3 刷选 | 5h | 49h |
| M4 套索选择 | 5h | 54h |
| M5 连通选择 | 6h | 60h |
| M6 纹理视图 | 7h | 67h |
| M7 基础绘制 | 14h | 81h |
| M8 克隆修复 | 10h | 91h |
| M9 颜色调整 | 12h | 103h |
| M10 几何修复 | 16h | 119h |
| M11 导入导出 | 18h | 137h |
| **总计** | **~137h** | - |

---

## 快速启动：M1 第一周任务

```
Day 1: T1.1.1 → T1.1.5 (项目骨架 + Qt窗口)
Day 2: T1.2.1 → T1.2.7 (DiligentEngine集成)
Day 3: T1.3.1 → T1.3.4 (数据结构) + T1.4.1 → T1.4.4 (模型加载)
Day 4: T1.5.1 → T1.5.6 (网格渲染)
Day 5: T1.6.1 → T1.6.5 (相机) + T1.7.1 → T1.7.3 (撤销)
Day 6: T1.8.1 → T1.8.9 (Qt主窗口布局)
```

---

**文档版本**: 2.0 (Qt 方案)
**最后更新**: 2025-12-26
